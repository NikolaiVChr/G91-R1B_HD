<?xml version="1.0"?>

<!--
Original work Copyright (c) 2018-2019 Adriano Bassignana (abassign)
Create the program to centralization of the braking system
Modify the program for steer limitation
Modified work Copyright 2019 Joshua Davidson (it0uchpods)
Modify the program for gear[0] pivoting
-->


<system name="gears">
    
    <property value="-60">systems/gears/gear[0]/z</property>
    <property value="-55">systems/gears/gear[1]/z</property>
    <property value="-55">systems/gears/gear[2]/z</property>
    
    <property value="0.0">systems/gears/gear[0]/is-stationary</property>
    <property value="0.0">systems/gears/gear[0]/slip-angle-deg-lag</property>
    <property value="20.0">systems/gears/gear[0]/slip-angle-deg-max</property>
    <property value="1.0">systems/gears/gear[0]/landingGearSteerLimitationFx-sign</property>
    <property value="-1.0">systems/gears/gear[0]/landingGearSteerLimitationFy-sign</property>
    <property value="5.0">systems/gears/gear[0]/steering-angle-deg-limiter-force</property>
    <property value="2.0">systems/gears/gear[0]/steering-angle-deg-limiter-force-exp</property>
    <property value="0.0">systems/gear/lever-rotation</property>
    
    <property value="0">systems/gears/init-passed</property>
    <property value="1">systems/gears/init-in-progress</property>
    
    <channel name="Init" execrate="1" execute="systems/gears/init-in-progress">
        
        <switch name="systems/gears/nop-0">
            <default value="1"/>
            <test value="0" logic="AND">
                position/h-agl-ft gt 12
            </test>
            <output>gear/gear-pos-norm</output>
            <output>/controls/gear/gear-down</output>
        </switch>
             
        <fcs_function name="systems/gears/nop-1">
            <function>
                <v>1</v> 
            </function>
            <output>systems/gears/init-passed</output>
        </fcs_function>
        
        <fcs_function name="systems/gears/nop-2">
            <function>
                <v>0</v> 
            </function>
            <output>systems/gears/init-in-progress</output>
        </fcs_function>
        
    </channel>
    
    <channel name="Landing Gear[0] steer" execrate="1">
        <!-- Calcolare una reazione quando lo steer supera 40° 
        Punto di applicazione è il carrello anteriore il valore deve essere tale da ridurre lo steer e riportarlo a 40° è quindi un attuatore
        -->
        
        <fcs_function name="systems/gears/gear[0]/is-stationary">
            <function>
                <ifthen>
                    <and>
                        <gt>
                            <p>gear/unit[0]/compression-ft</p>
                            <v>0.01</v>
                        </gt>
                        <lt>
                            <p>gear/unit[0]/wheel-speed-fps</p>
                            <v>0.1</v>
                        </lt>
                    </and>
                    <v>1.0</v>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/gears/gear[0]/slip-angle-deg">
            <function>
                <difference>
                    <ifthen>
                        <gt>
                            <p>gear/unit[0]/compression-ft</p>
                            <v>0.001</v>
                        </gt>
                        <p>gear/unit[0]/steering-angle-deg</p>
                        <v>0.0</v>
                    </ifthen>
                    <v>0.0</v>
                </difference>
            </function>
        </fcs_function>
        
        <lag_filter name="systems/gears/gear[0]/slip-angle-deg-lag">
            <input>systems/gears/gear[0]/slip-angle-deg</input>
            <c1>2.0</c1>
        </lag_filter>
        
        <switch name="systems/gears/gear[0]/steering-angle-deg-limiter-active">
            <default value="0"/>
            <test value="1" logic="AND">
                gear/unit[0]/WOW ne 0
                gear/unit[0]/wheel-speed-fps GT 0.1
            </test>
        </switch>
        
        <fcs_function name="systems/gears/gear[0]/steering-angle-deg-limiter-norm">
            <function>
                <ifthen>
                    <and>
                        <gt>
                            <abs>
                                <quotient>
                                    <p>systems/gears/gear[0]/slip-angle-deg-lag</p>
                                    <p>systems/gears/gear[0]/slip-angle-deg-max</p>
                                </quotient>
                            </abs>
                            <v>1.0</v>
                        </gt>
                        <gt>
                            <p>systems/gears/gear[0]/steering-angle-deg-limiter-active</p>
                            <v>0.0</v>
                        </gt>
                    </and>
                    <product>
                        <difference>
                            <pow>
                                <abs>
                                    <quotient>
                                        <p>systems/gears/gear[0]/slip-angle-deg-lag</p>
                                        <p>systems/gears/gear[0]/slip-angle-deg-max</p>
                                    </quotient>
                                </abs>
                                <p>systems/gears/gear[0]/steering-angle-deg-limiter-force-exp</p>
                            </pow>
                            <p>systems/gears/gear[0]/steering-angle-deg-limiter-force</p>
                        </difference>
                        <p>systems/gears/gear[0]/steering-angle-deg-limiter-force</p>
                    </product>
                    <v>0.0</v>
                </ifthen>
            </function>
        </fcs_function>
        
        <fcs_function name="systems/gears/gear[0]/LandingGearSteerLimitationFx">
            <function>
                <product>
                    <!-- problema sistema di riferimento carrello -->
                    <sin>
                        <p>systems/gears/gear[0]/slip-angle-deg-lag</p>
                    </sin>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-norm</p>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-force</p>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-active</p>
                    <p>systems/gears/gear[0]/landingGearSteerLimitationFx-sign</p>
                </product>
            </function>
            <output>external_reactions/LandingGearSteerLimitationFx/magnitude</output>
        </fcs_function>
        
        <fcs_function name="systems/gears/gear[0]/LandingGearSteerLimitationFy">
            <function>
                <product>
                    <cos>
                        <p>systems/gears/gear[0]/slip-angle-deg-lag</p>
                    </cos>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-norm</p>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-force</p>
                    <p>systems/gears/gear[0]/steering-angle-deg-limiter-active</p>
                    <p>systems/gears/gear[0]/landingGearSteerLimitationFy-sign</p>
                </product>
            </function>
            <output>external_reactions/LandingGearSteerLimitationFy/magnitude</output>
        </fcs_function>

    </channel>
    
    
    <channel name="Landing Gear control" execrate="8" execute="systems/gears/init-passed">
        
        <kinematic name="gear/gear-pos-norm">
            <input>gear/gear-cmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     12 </time>
                </setting>
            </traverse>
        </kinematic>
        
        <switch name="Set gear direction">
            <default value="0"/>
            <test logic="AND" value="1">
                gear/gear-cmd-norm EQ 0
                gear/gear-pos-norm GT 0
                gear/gear-pos-norm LT 1
            </test>
            <test logic="AND" value="-1">
                gear/gear-cmd-norm EQ 1
                gear/gear-pos-norm GT 0
                gear/gear-pos-norm LT 1
            </test>
            <output>gear/gear-direction</output>
        </switch>
        
        <fcs_function name="gear sound roumble">
            <function>
                <product>
                    <p>gear/gear-pos-norm</p>
                    <p>aero/qbar-psf</p>
                    <v>0.002</v>
                </product>
            </function>
            <output>gear/gear-pos-norm-sound-roumble</output>
        </fcs_function>
        
        <kinematic name="Gear Control Sound">
            <input>gear/gear-cmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     17.5 </time>
                </setting>
            </traverse>
            <output>gear/gear-pos-norm-sound</output>
        </kinematic>
        
        <switch name="Set gear direction sound">
            <default value="0"/>
            <test logic="AND" value="1">
                gear/gear-cmd-norm EQ 0
                gear/gear-pos-norm-sound GT 0
                gear/gear-pos-norm-sound LT 1
            </test>
            <test logic="AND" value="-1">
                gear/gear-cmd-norm EQ 1
                gear/gear-pos-norm-sound GT 0
                gear/gear-pos-norm-sound LT 1
            </test>
            <output>gear/gear-direction-sound</output>
        </switch>
        
        <lag_filter name="systems/gear/lever-rotation-lag">
            <input>gear/gear-cmd-norm</input>
            <c1>3.0</c1>
        </lag_filter>
        
    </channel>
    
    
    <channel name="Landing gear hydraulics extension" execrate="8">
        
        <summer>
            <input>systems/gears/gear[0]/z</input>
            <input>systems/gears/unit[0]/hydraulics-extension</input>
            <output>gear/unit[0]/z-position</output>
        </summer>
        
        <summer>
            <input>systems/gears/gear[1]/z</input>
            <input>systems/gears/unit[1]/hydraulics-extension</input>
            <output>gear/unit[1]/z-position</output>
        </summer>
        
        <summer>
            <input>systems/gears/gear[2]/z</input>
            <input>systems/gears/unit[2]/hydraulics-extension</input>
            <output>gear/unit[2]/z-position</output>
        </summer>
        
    </channel>
    
    
    <channel name="drag gear" execrate="8">
        
        <pure_gain>
            <input>systems/gears/gear[0]/drag-norm</input>
            <gain>2.0</gain>
            <output>external_reactions/LandingGearFrontAerodinamicDrag/magnitude</output>
        </pure_gain>
        
        <pure_gain>
            <input>systems/gears/gear[1]/drag-norm</input>
            <gain>4.0</gain>
            <output>external_reactions/LandingGearRightAerodinamicDrag/magnitude</output>
        </pure_gain>
        
        <pure_gain>
            <input>systems/gears/gear[2]/drag-norm</input>
            <gain>4.0</gain>
            <output>external_reactions/LandingGearLeftAerodinamicDrag/magnitude</output>
        </pure_gain>
        
    </channel>
    
    
    <function name="systems/gears/unit[0]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0 0.0
                1000.0 0.0
                3000.0 0.0
                4000.0 0.0
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/unit[1]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0  0.0
                3000.0 -5
                4000.0 -5
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/unit[2]/hydraulics-extension">
        <description>Extension main gear hydraulic cylinder</description>
        <table>
            <independentVar>systems/hydraulics/flight-system-psi</independentVar>
            <tableData>
                0.0  0.0
                3000.0 -5
                4000.0 -5
            </tableData>
        </table>
    </function>
    
    <function name="systems/gears/gear[0]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.292
                    0.4  0.559
                    0.6  0.777
                    0.8  0.927
                    1.0  0.996
                </tableData>
            </table>
        </product>
    </function>
    
    <function name="systems/gears/gear[1]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.309
                    0.4  0.588
                    0.6  0.809
                    0.8  0.951
                    1.0  1.000
                </tableData>
            </table>
        </product>
    </function>
    
    <function name="systems/gears/gear[2]/drag-norm">
        <product>
            <p>aero/qbar-psf</p>
            <table>
                <independentVar>gear/gear-pos-norm</independentVar>
                <tableData>
                    0.0  0.0
                    0.2  0.309
                    0.4  0.588
                    0.6  0.809
                    0.8  0.951
                    1.0  1.000
                </tableData>
            </table>
        </product>
    </function>
    
</system>

